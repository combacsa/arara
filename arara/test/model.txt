#
>>> import arara.model
>>> arara.model.init_test_database()
>>> import arara
>>> import arara.server
>>> arara.server.server = arara.get_namespace()
>>> server = arara.get_namespace()

# Faking time.time (to check time field)

>>> import time
>>> def stub_time():
...     return 1.1
>>> org_time = time.time
>>> time.time = stub_time

>>> from arara.model import *

# Login as SYSOP and create 'garbage' board

>>> ret, session_key_sysop = server.login_manager.login(u'SYSOP', u'SYSOP', '123.123.123.123')
>>> ret
True

>>> server.board_manager.add_board(session_key_sysop, u'garbages', u'Garbage Board')
(True, 'OK')

# Register one user, serialx
>>> user_reg_dic = {'username':u'serialx', 'password':u'serialx', 'nickname':u'serialx', 'email':u'serialx@example.com', 'signature':u'serialx', 'self_introduction':u'serialx', 'default_language':u'english' }
>>> ret, register_key = server.member_manager.register(user_reg_dic)
>>> ret
True
>>> server.member_manager.confirm(u'serialx', register_key)
(True, 'OK')
>>> ret, session_key_serialx = server.login_manager.login(u'serialx', u'serialx', '143.248.234.140')
>>> ret
True

>>> session = Session()
>>> board = session.query(Board).filter_by(board_name=u'garbages').one()
>>> serialx = session.query(User).filter_by(username=u'serialx').one()
>>> a = Article(board, u'title1', u'content', serialx, u'0.0.0.0', None)
>>> b = Article(board, u'title2', u'content', serialx, u'0.0.0.0', a)
>>> c = Article(board, u'title3', u'content', serialx, u'0.0.0.0', b)
>>> d = Article(board, u'title4', u'content', serialx, u'0.0.0.0', c)
>>> session.save(a)
>>> session.save(b)
>>> session.save(c)
>>> session.save(d)
>>> session.commit()
>>> d.root
<Article('title1', 'serialx', 1970-01-01 09:00:01.100000)>
>>> d.parent
<Article('title3', 'serialx', 1970-01-01 09:00:01.100000)>
>>> c.children
[<Article('title4', 'serialx', 1970-01-01 09:00:01.100000)>]
>>> a.descendants
[<Article('title2', 'serialx', 1970-01-01 09:00:01.100000)>, <Article('title3', 'serialx', 1970-01-01 09:00:01.100000)>, <Article('title4', 'serialx', 1970-01-01 09:00:01.100000)>]


>>> session = Session()
>>> a = session.query(Article).filter_by(title=u'title1').one()
>>> c = session.query(Article).filter_by(title=u'title3').one()
>>> d = session.query(Article).filter_by(title=u'title4').one()
>>> d.root
<Article('title1', 'serialx', 1970-01-01 09:00:01.100000)>
>>> d.parent
<Article('title3', 'serialx', 1970-01-01 09:00:01.100000)>
>>> c.children
[<Article('title4', 'serialx', 1970-01-01 09:00:01.100000)>]
>>> a.descendants
[<Article('title2', 'serialx', 1970-01-01 09:00:01.100000)>, <Article('title3', 'serialx', 1970-01-01 09:00:01.100000)>, <Article('title4', 'serialx', 1970-01-01 09:00:01.100000)>]


>>> time.time = org_time

# Reset the database
>>> import arara.model
>>> arara.model.clear_test_database()
