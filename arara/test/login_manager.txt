
# load LoginManager & MemberManager

>>> from arara_thrift.ttypes import *
>>> import arara.model
>>> arara.model.init_test_database()
>>> import arara
>>> server = arara.get_namespace()

# Faking time.time (to check time field)

>>> import time
>>> def stub_time():
...     return 1.1
>>> org_time = time.time
>>> time.time = stub_time

# Register pipoket

>>> user_reg_dic = {'username':u'pipoket', 'password':u'pipoket', 'nickname':u'pipoket', 'email':u'pipoket@example.com', 'signature':u'pipoket', 'self_introduction':u'pipoket', 'default_language':u'english' }
>>> register_key = server.member_manager.register(UserRegistration(**user_reg_dic))
>>> server.member_manager.confirm(u'pipoket', unicode(register_key))

# Register serialx

>>> user_reg_dic = {'username':u'serialx', 'password':u'serialx', 'nickname':u'serialx', 'email':u'serialx@example.com', 'signature':u'serialx', 'self_introduction':u'serialx', 'default_language':u'serialx' }
>>> register_key = server.member_manager.register(UserRegistration(**user_reg_dic))
>>> server.member_manager.confirm(u'serialx', unicode(register_key))

# Login as both user

>>> session_key = server.login_manager.login(u'pipoket', u'pipoket', u'143.248.234.145')
>>> session_key_serialx = server.login_manager.login(u'serialx', u'serialx', u'143.248.234.140')

# Wrong login test

>>> server.login_manager.login(u'pipoket', u'not_test', '143.248.234.145')
Traceback (most recent call last):
  ...
InvalidOperation
>>> server.login_manager.login(u'not_test', u'test', '143.248.234.145')
Traceback (most recent call last):
  ...
InvalidOperation

#>>> server.login_manager.login(u'pipoket', u'pipoket', u'143.248.234.145')
#(False, 'ALREADY_LOGIN')

# Session key test

>>> session_bee = u'thisisnotapropermd5sessionkey...'
>>> server.login_manager.is_logged_in(unicode(session_bee))
False
>>> server.login_manager.is_logged_in(unicode(session_key))
True

# Get session test

>>> result = server.login_manager.get_session(unicode(session_key))
>>> result.ip
u'143.248.234.145'
>>> result.username
u'pipoket'

# Get online user info test

>>> sessions = server.login_manager.get_current_online(session_key)
>>> [x.__dict__ for x in sessions]
[{'username': u'pipoket', 'ip': u'143.248.234.145', 'current_action': 'login_manager.login()', 'nickname': u'pipoket', 'logintime': 1.1000000000000001}, {'username': u'serialx', 'ip': u'143.248.234.140', 'current_action': 'login_manager.login()', 'nickname': u'serialx', 'logintime': 1.1000000000000001}]
>>> server.login_manager.get_current_online(session_bee)
Traceback (most recent call last):
  ...
NotLoggedIn

# Logout test

>>> server.login_manager.logout(unicode(session_bee))
Traceback (most recent call last):
  ...
NotLoggedIn
>>> server.login_manager.logout(unicode(session_key))
>>> server.login_manager.logout(unicode(session_key))
Traceback (most recent call last):
  ...
NotLoggedIn

>>> time.time = org_time

# Count test

>>> _ = server.login_manager.total_visitor() 
>>> _ = server.login_manager.total_visitor() 
>>> _ = server.login_manager.total_visitor() 
>>> server.login_manager.total_visitor().__dict__
{'total_visitor_count': 4, 'today_visitor_count': 4}

# Reset the database
>>> import arara.model
>>> arara.model.clear_test_database()
